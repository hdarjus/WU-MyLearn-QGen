[//]: # "Created by Jana Hlavinova, Institute for Statistics and Mathematics, WU Vienna"

```{r, echo=FALSE, results="hide"}
asy.binom.test <- function(x, n, p = 0.5,
  alternative = c("two.sided", "less", "greater"), conf.level = 0.95,
  sd.method = c("bootstrap", "robust"))
{
  ## process data
  if(missing(n)) {
    stopifnot(length(x) > 1, length(unique(x)) <= 2)
    tab <- table(as.factor(x))
    if(length(tab) < 2) {
      phat <- 0 
      snam <- "success"
    } else {
      phat <- tab[2]/sum(tab)
      snam <- names(tab)[2]
    }
    n <- sum(tab)    
    dnam <- deparse(substitute(x))
  } else {
    stopifnot(length(n) == 1, length(x) == 1, is.numeric(n), is.numeric(x))
    phat <- x/n
    dnam <- paste(x, "and", n)
    snam <- "success"
  }
  
  ## test, p-value
  zstat <- (phat - p)/sqrt(p * (1-p)/n)
  alternative <- match.arg(alternative)
  pval <- switch(alternative,
    "two.sided" = pnorm(abs(zstat), lower.tail = FALSE)*2,
    "less" = pnorm(zstat),
    "greater" = pnorm(zstat, lower.tail = FALSE))
 
  ## confidence interval
  sd.method <- match.arg(sd.method)
  SDhat <- switch(sd.method,
    "bootstrap" = sqrt(phat * (1 - phat) / n),
    "robust" = 1/(2 * sqrt(n)))
  ci <- switch(alternative,
    "two.sided" = phat + c(1, -1) * qnorm((1 - conf.level)/2) * SDhat,
    "less" = c(0, phat + qnorm(conf.level) * SDhat),
    "greater" = c(phat - qnorm(conf.level) * SDhat, 1))
  attr(ci, "conf.level") <- conf.level

  rval <- list(
    statistic = structure(zstat, .Names = "Z"),
    p.value = pval,
    conf.int = ci,
    estimate = structure(phat, .Names = paste("probability of", snam)),
    null.value = structure(p, .Names = paste("probability of", snam)),
    alternative = alternative,
    method = "Asymptotic binomial test",
    data.name = dnam    
  )
  class(rval) <- "htest"
  return(rval)  
}

##pvalcheck <- 0.051 #  HACK TO PREVENT CONFLICTING CONCLUSIONS BECAUSE OF USING NORMAL OR T-DIST
##Tstatcheck <- 1.65
##while (pvalcheck > 0.0499 & Tstatcheck > 1.64) {
## n <- sample(c(40,45,50,55,60,70,80), 1)
## mu0 <- sample( seq(60,100,5), 1)
##
## diff <- sample( c(-1.7, -1.3, -1, seq(1, 6, 0.5)), 1)
## sdx  <- sample( seq(7, 10, 0.5), 1)
## x <- rnorm(n, sd = sdx)
##
## dauer <- mu0 + diff - mean(x) + x 
##
## testdauer <- t.test(dauer, mu = mu0, alternative = "g")
##
## pvalcheck <- testdauer$p.value
## Tstatcheck <- testdauer$statistic
##}

n <- sample( seq(80, 170, 10), 1)
theta0proz <- sample( seq(20, 40, 5), 1)
theta0     <- theta0proz/100

erw  <- n*theta0
vare <- sqrt(erw*(1-theta0))

erf  <- round( sample( c( seq(erw-1.5*vare, erw-3, 1), seq( erw+4, erw+3*vare, 1)), 1))
## side <- sample(c(1,3), 1) ## 1 - zweiseitig  2 - linkseitig  3 - rechtsseitig
side <- 3


if (side == 1) {tasy <- asy.binom.test( erf, n, p=theta0, alt="t")}
if (side == 2) {tasy <- asy.binom.test( erf, n, p=theta0, alt="l")}
if (side == 3) {tasy <- asy.binom.test( erf, n, p=theta0, alt="g")}

if (side == 1) {sol_hypo <- "zweiseitiger"}
if (side == 3) {sol_hypo <- "einseitiger (rechtsseitiger)"}

## QUESTION/ANSWER GENERATION
questions <- character(5)
solutions <- logical(5)
explanations <- character(5)

## 1. hypothesen
anzfragen <- 3
ques <- character(anzfragen)
solu <- logical(anzfragen)
expl <- character(anzfragen)

ques[1] <- paste0("Der gerechnete Test hat als Alternativhypothese $H_A: \\theta > ",theta0,"$.")
solu[1] <- (side == 3)
if (side == 1) {expl[1] <- paste0("Es ist ein zweiseitiger Test gegen diesen Wert.")}
if (side == 3) {expl[1] <- paste0("Es ist ein einseitiger (genauer: rechtsseitiger) Test gegen diesen Wert.")}

ques[2] <- paste0("Der gerechnete Test hat als Alternativhypothese $H_A: \\theta \\neq ",theta0,"$.")
solu[2] <- (side == 1)
if (side == 1) {expl[2] <- paste0("Es ist ein zweiseitiger Test gegen diesen Wert.")}
if (side == 3) {expl[2] <- paste0("Es ist kein zweiseitiger Test, sondern ein einseitiger.")}

ques[3] <- paste0("Der gerechnete Test hat als Nullhypothese $H_0: \\theta \\leq ",theta0,"$.")
solu[3] <- (side == 3)
if (side == 1) {expl[3] <- paste0("Es ist ein zweiseitiger Test gegen diesen Wert.")}
if (side == 3) {expl[3] <- paste0("Es ist ein einseitiger (genauer: rechtsseitiger) Test gegen diesen Wert.")}

welche <- sample(1:anzfragen,1)

questions[1]    <- ques[welche]
solutions[1]    <- solu[welche]
explanations[1] <- expl[welche]


## 2. teststatistik
anzfragen <- 3
ques <- character(anzfragen)
solu <- logical(anzfragen)
expl <- character(anzfragen)

teststat <- as.numeric(tasy[1])
vgl1 <- round(teststat, digits=2)
vgl2 <- sample( seq(0.5, 2.5, 0.1), 1)
vgl3 <- sample( seq(0.6, 3.5, 0.1), 1)

ques[1] <- paste0("Der Wert der Teststatistik ist (gerundet): $",vgl1,"$.")
solu[1] <- TRUE
expl[1] <- paste0("Der Wert kann aus dem Testoutput (Z = ) abgelesen werden.")

ques[2] <- paste0("Der Wert der Teststatistik ist kleiner als $",vgl2,"$.")
solu[2] <- (teststat < vgl2)
expl[2] <- paste0("Der Wert kann aus dem Testoutput (Z = ) abgelesen werden.")

ques[3] <- paste0("Der Wert der Teststatistik ist größer als $",vgl3,"$.")
solu[3] <- (teststat > vgl3)
expl[3] <- paste0("Der Wert kann aus dem Testoutput (Z = ) abgelesen werden.")

welche <- sample(1:anzfragen,1)

questions[2]    <- ques[welche]
solutions[2]    <- solu[welche]
explanations[2] <- expl[welche]


## 3. stichprobe
anzfragen <- 3
ques <- character(anzfragen)
solu <- logical(anzfragen)
expl <- character(anzfragen)

fn   <- round(as.numeric(tasy[4]), digits=5)

ques[1] <- paste0("Der Anteil in der Stichprobe ist (gerundet) $",fn,"$.")
solu[1] <- TRUE
expl[1] <- paste0("Das kann aus dem Output abgelesen werden (\\texttt{sample estimates}).")

ques[2] <- paste0("Der Anteil in der Stichprobe ist größer als der Anteilswert, der überprüft werden soll.")
solu[2] <- (fn > theta0)
expl[2] <- paste0("Die angesprochenen Werte stehen im Output.")

ques[3] <- paste0("Der Anteil in der Stichprobe ist $",theta0,"$.")
solu[3] <- FALSE
expl[3] <- paste0("Das ist der Wert, der mit dem Test überprüft werden soll.")

welche <- sample(1:anzfragen,1)

questions[3]    <- ques[welche]
solutions[3]    <- solu[welche]
explanations[3] <- expl[welche]



## 4. p-wert
anzfragen <- 3
ques <- character(anzfragen)
solu <- logical(anzfragen)
expl <- character(anzfragen)

pwert <- as.numeric(tasy[2])
pwvgl <- sample( seq(0.01, 0.20, 0.01), 1)

ques[1] <- paste0("Der p-Wert ist kleiner als $",pwvgl,"$.")
solu[1] <- (pwert < pwvgl)
expl[1] <- paste0("Steht im Output (\\texttt{p-value}).")

ques[2] <- paste0("Es liegt ein signifikantes Ergebnis vor.")
solu[2] <- (pwert < 0.05)
expl[2] <- paste0("Wenn der p-Wert kleiner als das Signifikanzniveau ist, ist das Ergebnis signifikant.")

ques[3] <- paste0("Das Ergebnis ist nicht signifikant.")
solu[3] <- (pwert >= 0.05)
expl[3] <- paste0("Das Ergebnis ist nicht signifikant, wenn der p-Wert über dem Signifikanzniveau liegt.")

welche <- sample(1:anzfragen,1)

questions[4]    <- ques[welche]
solutions[4]    <- solu[welche]
explanations[4] <- expl[welche]


##  5. interpretation
##  
anzfragen <- 3
ques <- character(anzfragen)
solu <- logical(anzfragen)
expl <- character(anzfragen)

ques[1] <- paste0("Der Test bestätigt die Alternativhypothese.")
solu[1] <- (pwert < 0.05)
expl[1] <- paste0("Ist der p-Wert kleiner als das Signifikanzniveau, wird die Alternativhypothese angenommen. Sonst bleibt man bei der Nullhypothese.")

if (side == 1) {ques[2] <- paste0("Der Anteilswert erfolgreicher Mediationen ist statistisch nicht signifikant von $",theta0,"$ verschieden.")}
if (side == 3) {ques[2] <- paste0("Der Anteilswert erfolgreicher Mediationen ist statistisch nicht signifikant größer als $",theta0,"$.")}
solu[2] <- (pwert >= 0.05)
expl[2] <- paste0("Liegt der p-Wert über dem Signifikanzniveau, wird die Nullhypothese beibehalten. Sonst wird sie verworfen.")

if (side == 1) {ques[3] <- paste0("Die Daten bestätigen: Der Anteil erfolgreicher ist nicht $",theta0proz,"$ Prozent.")}
if (side == 3) {ques[3] <- paste0("Die Daten bestätigen: Der Anteil erfolgreicher Mediationen liegt über $",theta0proz,"$ Prozent.")}
solu[3] <- (pwert < 0.05)
expl[3] <- paste0("Liegt der p-Wert unter dem Signifikanzniveau, wird die Nullhypothese verworfen. Sonst wird sie beibehalten.")

welche <- sample(1:anzfragen,1)

questions[5]    <- ques[welche]
solutions[5]    <- solu[welche]
explanations[5] <- expl[welche]


```

Question
========
Mobbing stellt im Berufsleben zunehmend ein Problem dar, das nicht nur die von Mobbing direkt Betroffenen in existentielle Krisen 
stürzen kann, sondern auch die Unternehmen, die mit schlechtem Arbeitsklima, Personalwechsel etc. zu kämpfen haben.
In einem Großkonzern wird bei solchen Fällen ein neues Angebot versucht: 
Durch Mediation sollen Konflikte nicht ausufern, sondern relativ rasch abgefedert werden. 
Allerdings soll dieses kostenintensive Angebot nur erhalten bleiben, wenn die Erfolgsquote -- wie auch immer definiert -- über $`r theta0proz`$\% liegt.
Es wurde der folgende Anteilstest gerechnet (Signifikanzniveau 5\%).
```{r output, echo = FALSE, comment = NA}
print(tasy)
```
Answerlist
----------
* `r questions[1]`
* `r questions[2]`
* `r questions[3]`
* `r questions[4]`
* `r questions[5]`

Solution
========
Ein Anteilstest wurde gerechnet, mit dem der Anteil von $`r theta0`$ (also $`r theta0proz`$ Prozent) überprüft wurde.
Die Alternativhypothese kann aus dem Testergebnis abgeleitet werden (\texttt{alternative hypothesis}), es ist ein 
`r sol_hypo` Test.
In der Stichprobe ist der Anteilswert $`r fn`$.
Der Wert der Teststatistik ist $`r round(teststat,digits=4)`$, der p-Wert beträgt rund $`r round(pwert,digits=4)`$.
```{r solutionlist, echo = FALSE, results = "asis"}
answerlist(ifelse(solutions, "True", "False"), explanations, markup = "markdown")
```

Meta-information
================
exname: First Question
extype: mchoice
exsolution: `r mchoice2string(solutions)`
exshuffle: TRUE
